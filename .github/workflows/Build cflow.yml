name: Build cflow

on: 
  workflow_dispatch:  # 手动触发（原功能保留）
  push:               # 新增：推送代码（含 YAML 修改）自动触发
    branches: [ main ]  # 可选：限制仅 main 分支推送触发（可根据实际分支名修改）

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'
        check-latest: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Clone Repo
      run: |
        git clone https://github.com/Vespa314/cflow.git
        export PNPM_HOME="/home/runner/.pnpm-global"
        export PATH="$PNPM_HOME/bin:$PATH"
        npm install -g pnpm
        pnpm --version
        pnpm add -g @bufbuild/buf@1.47.2
        buf --version

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'
        check-latest: true
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
           ${{ runner.os }}-go-

    - name: Build Frontend
      run: |
        cd cflow/web
        # export COREPACK_SKIP_SIGNATURES=true
        # corepack enable && export COREPACK_SKIP_SIGNATURES=true && pnpm i --frozen-lockfile
        pnpm i --frozen-lockfile

        echo "正在生成 Protobuf TS 类型文件..."
        mkdir -p src/types/proto  # 确保输出目录存在

        # 步骤1：找到 proto 子目录（api/v2）
        PROTO_ROOT_DIR="../proto"
        if [ ! -d "$PROTO_ROOT_DIR" ]; then
          echo "错误：未找到 proto 根目录！路径：$PROTO_ROOT_DIR"
          exit 1
        fi
        echo "proto 根目录：$PROTO_ROOT_DIR"

        # 步骤2：强制创建 buf.yaml（明确配置 roots）
        cat > "$PROTO_ROOT_DIR/buf.yaml" << EOF
        version: v2
        build:
          roots: ["./api/v2"]  # 明确 proto 文件目录
        EOF
        echo "已创建 buf.yaml 配置："
        cat "$PROTO_ROOT_DIR/buf.yaml"  # 验证配置
        
        # 步骤3：在 proto 根目录执行 buf generate（修改执行目录和输出路径）
        cd "$PROTO_ROOT_DIR"
        pnpm exec buf generate \
          -o ../web/src/types/proto \
          --template '{"plugins": [{"name": "ts", "opt": ["target=ts", "import_extension=.js", "esModuleInterop=true"]}]}'

        # 步骤4：返回 web 目录继续构建
        cd ../web
        rm -f "$PROTO_ROOT_DIR/buf.yaml"  # 删除临时配置
        echo "已删除临时 buf.yaml 配置"
        
        pnpm build
        mkdir -p ../artifact
        rm -rf ../server/router/frontend/dist
        mkdir -p ../server/router/frontend
        cp -R dist ../server/router/frontend/dist
        cd ../..

    - name: Build binary
      run: |
        cd cflow
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow.exe && cd artifact && tar -czvf ../cflow-windows-amd64.tar.gz * && cd ..
        GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-freebsd-amd64.tar.gz * && cd ..
        GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-darwin-amd64.tar.gz * && cd ..
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-linux-amd64.tar.gz * && cd ..
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-linux-arm64.tar.gz * && cd ..
        cd ..
        
    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: cflow-pre-built
        path: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
            cflow/cflow-linux-arm64.tar.gz
            
    - name: Generate release tag
      id: tag
      run: echo "release_tag=$(wget -qO- https://api.github.com/repos/Vespa314/cflow/tags | gawk -F '["v]' '/name/{print "v"$5;exit}')" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        files: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
            cflow/cflow-linux-arm64.tar.gz
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 8