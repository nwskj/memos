name: Build

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'
        check-latest: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install system dependencies
      run: |
        # 安装 Protobuf 编译器（生成 TS 类型必需）
        sudo apt update && sudo apt install -y protobuf-compiler jq

    - name: Clone Repo
      run: |
        git clone https://github.com/Vespa314/cflow.git
        npm install -g pnpm

    - name: Build Frontend (含 Protobuf 类型生成)
      run: |
        cd cflow/web
        # 安装前端依赖（含 protoc-gen-ts_proto 生成插件）
        pnpm i --frozen-lockfile
        # 回到项目根目录，生成 Protobuf TypeScript 类型文件
        cd ..
        # 1. 确认 proto 文件路径（适配项目实际结构）
        PROTO_DIR="./proto/api/v2"
        if [ ! -d "$PROTO_DIR" ]; then
          PROTO_DIR="./web/proto/api/v2"  # 备用路径（若 proto 在 web 目录下）
        fi
        echo "使用 proto 文件路径：$PROTO_DIR"
        
        # 2. 生成 TS 类型文件（输出到 web/src/types/proto，对应代码中的 @/types/proto）
        protoc \
          --plugin=./web/node_modules/.bin/protoc-gen-ts_proto \
          --ts_proto_out=./web/src/types/proto \
          --ts_proto_opt=esModuleInterop=true,forceLong=string,useOptionals=messages \
          $PROTO_DIR/*.proto
        
        # 3. 验证类型文件是否生成成功
        ls -la ./web/src/types/proto/api/v2/ || echo "警告：类型文件未生成，可能 proto 路径错误"
        
        # 4. 重新进入 web 目录执行前端编译
        cd web
        pnpm build
        
        # 5. 复制前端产物到 server 目录（保持原有逻辑）
        mkdir -p ../artifact
        rm -rf ../server/router/frontend/dist
        mkdir -p ../server/router/frontend
        cp -R dist ../server/router/frontend/dist
        cd ../..

    - name: Build binary
      run: |
        cd cflow
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow.exe && cd artifact && tar -czvf ../cflow-windows-amd64.tar.gz * && cd ..
        GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-freebsd-amd64.tar.gz * && cd ..
        GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-darwin-amd64.tar.gz * && cd ..
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o cflow ./cmd/cflow/main.go && rm -f artifact/* && cp cflow artifact/cflow && cd artifact && tar -czvf ../cflow-linux-amd64.tar.gz * && cd ..
        cd ..
        
    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: cflow-pre-built
        path: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
            
    - name: Generate release tag
      id: tag
      run: |
        LATEST_TAG=$(wget -qO- https://api.github.com/repos/Vespa314/cflow/tags | jq -r '.[0].name' | sed 's/^v//')
        echo "release_tag=v$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "原始标签：$LATEST_TAG，最终标签：v$LATEST_TAG"

    - name: Delete existing tag (if exists)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG_NAME: ${{ steps.tag.outputs.release_tag }}
      run: |
        cd cflow
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "删除本地标签 $TAG_NAME"
          git tag -d "$TAG_NAME"
        fi
        echo "删除远程标签 $TAG_NAME"
        git push origin --delete "$TAG_NAME" 2>/dev/null || echo "远程标签 $TAG_NAME 不存在，无需删除"

    - name: Create release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        files: |
            cflow/cflow-windows-amd64.tar.gz
            cflow/cflow-freebsd-amd64.tar.gz
            cflow/cflow-darwin-amd64.tar.gz
            cflow/cflow-linux-amd64.tar.gz
        overwrite: true

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 8
